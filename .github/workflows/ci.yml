name: ğŸš€ Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          cd apps/web
          npm ci
          
      - name: ğŸ§ª Run tests
        run: |
          cd apps/web
          npm run test:ci
          
      - name: ğŸ” Run linter
        run: |
          cd apps/web
          npm run lint
          
      - name: ğŸ—ï¸ Build project
        run: |
          cd apps/web
          npm run build

  test-backend:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          cd apps/backend
          npm ci
          
      - name: ğŸ§ª Run tests
        run: |
          cd apps/backend
          npm test
          
      - name: ğŸ” Run linter
        run: |
          cd apps/backend
          npm run lint

  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”’ Run security audit
        run: |
          cd apps/web && npm audit --audit-level moderate
          cd ../backend && npm audit --audit-level moderate

  code-quality:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“Š Run code quality checks
        uses: github/super-linter@v4
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_JAVASCRIPT_ES: true
          VALIDATE_JSON: true
          VALIDATE_MARKDOWN: true
          VALIDATE_YAML: true

  hacktoberfest-validation:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ¯ Validate Hacktoberfest PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            // Check if PR is from external contributor
            const isExternalContributor = pr.head.repo.full_name !== pr.base.repo.full_name;
            
            if (isExternalContributor) {
              // Check if PR has hacktoberfest label
              const { data: labels } = await github.rest.issues.listLabelsOnIssue({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number
              });
              
              const hasHacktoberfestLabel = labels.some(label => 
                label.name === 'hacktoberfest' || label.name === 'hacktoberfest-accepted'
              );
              
              if (!hasHacktoberfestLabel) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: `ğŸ‰ **Hacktoberfest 2024 Reminder**
                  
                  Hi @${pr.user.login}! ğŸ‘‹
                  
                  We noticed this is an external contribution. To make it eligible for Hacktoberfest 2024, please:
                  
                  1. **Add the `hacktoberfest` label** to your PR
                  2. **Link to an issue** using "Closes #issue_number" in your PR description
                  
                  ğŸ“š **Need help?** Check our [Hacktoberfest Guide](HACKTOBERFEST.md) for more information.
                  
                  **Thank you for contributing to Trawell! ğŸŒ**`
                });
              }
            }
